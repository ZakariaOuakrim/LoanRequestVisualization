/opt/hive/bin/beeline -u jdbc:hive2://localhost:10000

CREATE EXTERNAL TABLE LOAN_request(
    id STRING,
    address STRING,
    birthday STRING,
    email STRING,
    first_name STRING,
    id_number STRING,
    id_expiration_date STRING,
    phone_number STRING,
    rib STRING,
    sequence STRING,
    wallet_creation_date STRING,
    wallet_id STRING,
    last_name STRING,
    fk_id_type STRING,
    fk_nationality STRING,
    country_code STRING,
    entry_relation_date STRING,
    gender STRING,
    wallet_level STRING,
    internal_account_rib STRING,
    age STRING,
    m2t_client_id STRING,
    city_code STRING,
    city_label STRING,
    fk_client STRING,
    deleted STRING,
    version STRING,
    created_date STRING,
    awarded_amount STRING,
    awarded_duration STRING,
    channel_code STRING,
    code_ls STRING,
    fees STRING,
    label STRING,
    loan_contract_base64 STRING,
    partner_code STRING,
    pki_request_id STRING,
    rate STRING,
    requested_amount STRING,
    requested_deadlines STRING,
    requested_duration STRING,
    score STRING,
    status STRING,
    total_loan_amount STRING,
    bank_signed_contract_id STRING,
    client_signed_contract_id STRING,
    other_revenue STRING,
    people_in_charge_of STRING,
    revenue STRING,
    activity_sector_id STRING,
    employer_contract_type_id STRING,
    marital_status_id STRING,
    profession_id STRING,
    studies_level_id STRING,
    eservice_tracking_id STRING,
    client_signed_contract_ged_id STRING,
    credit_wallet_request_uid STRING,
    credit_wallet_transaction_ref STRING,
    ceiling_updated STRING,
    rejection_reason STRING,
    annual_rate STRING,
    annual_tci STRING,
    m2t_remuneration STRING,
    net_annual_rate STRING,
    effective_annual_rate_of_charge STRING,
    funds_unlock_retry_count STRING,
    nb_ops_paie_m1 STRING,
    nb_ops_paie_m2 STRING,
    nb_ops_paie_m3 STRING,
    nb_ops_paie_m4 STRING,
    nb_ops_paie_m5 STRING,
    nb_ops_paie_m6 STRING,
    nb_vir_recu_in_m1 STRING,
    nb_vir_recu_in_m2 STRING,
    nb_vir_recu_in_m3 STRING,
    nb_vir_recu_in_m4 STRING,
    nb_vir_recu_in_m5 STRING,
    nb_vir_recu_in_m6 STRING,
    mt_moy_hebdo_3m STRING,
    contract_nature STRING,
    moy_mens_pay_telec_1an STRING,
    moy_mens_pay_eauelec_1an STRING,
    moy_mens_trans_emis_1an STRING,
    moy_mens_trans_recus_1an STRING,
    nb_fact_oay_horsrecouv_1an STRING,
    nb_fact_oay_1an STRING,
    awarded_deadlines STRING,
    produit STRING,
    account_active STRING,
    cdg_creation_date STRING,
    cdg_nb_bourses STRING,
    cdg_total_amount STRING,
    cdgmad_creation_date STRING,
    cdgmad_gtrx_etat STRING,
    cdgmad_gtrx_mnt STRING,
    cdgmad_gtrx_num STRING,
    last_amount STRING,
    last_amount_date STRING,
    amount STRING,
    deadline STRING,
    epag_token STRING,
    epag_trx_number STRING,
    method STRING,
    payment_date STRING,
    fk_loan_request STRING,
    code STRING,
    channel_transaction_number STRING,
    paid_amount STRING,
    transaction_ref_debit STRING,
    transaction_ref_number_debit STRING
)ROW FORMAT DELIMITED
FIELDS TERMINATED BY '|'
STORED AS TEXTFILE;
LOCATION '/home/LoanrequestBcp.csv';


CREATE EXTERNAL TABLE clients (
  id STRING,
  deleted STRING,
  version STRING,
  created_date STRING,
  address STRING,
  birthday STRING,
  channel_code STRING,
  code_ls STRING,
  email STRING,
  first_name STRING,
  id_number STRING,
  id_expiration_date STRING,
  last_name STRING,
  partner_code STRING,
  phone_number STRING,
  rib STRING,
  sequence STRING,
  wallet_creation_date STRING,
  wallet_id STRING,
  fk_id_type STRING,
  fk_nationality STRING,
  country_code STRING,
  entry_relation_date STRING,
  gender STRING,
  wallet_level STRING,
  internal_account_rib STRING,
  age STRING,
  m2t_client_id STRING,
  city_code STRING,
  city_label STRING
) ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
STORED AS TEXTFILE;

CREATE EXTERNAL TABLE payment_deadline (
  id STRING,
  deleted STRING,
  version STRING,
  amount STRING,
  deadline STRING,
  epag_token STRING,
  epag_trx_number STRING,
  label STRING,
  method STRING,
  payment_date STRING,
  status STRING,
  fk_loan_request STRING,
  code STRING,
  channel_transaction_number STRING,
  created_date STRING,
  paid_amount STRING,
  transaction_ref_debit STRING,
  transaction_ref_number_debi STRING
) ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
STORED AS TEXTFILE;

CREATE EXTERNAL TABLE loan_request(
  id STRING,
  deleted STRING,
  version STRING,
  created_date STRING,
  awarded_amount STRING,
  awarded_duration STRING,
  channel_code STRING,
  code_ls STRING,
  fees STRING,
  label STRING,
  loan_contract_base64 STRING,
  partner_code STRING,
  pki_request_id STRING,
  rate STRING,
  requested_amount STRING,
  requested_deadlines STRING,
  requested_duration STRING,
  score STRING,
  status STRING,
  total_loan_amount STRING,
  bank_signed_contract_id STRING,
  fk_client STRING,
  client_signed_contract_id STRING,
  other_revenue STRING,
  people_in_charge_of STRING,
  revenue STRING,
  activity_sector_id STRING,
  employer_contract_type_id STRING,
  marital_status_id STRING,
  profession_id STRING,
  studies_level_id STRING,
  eservice_tracking_id STRING,
  client_signed_contract_ged_id STRING,
  credit_wallet_request_uid STRING,
  credit_wallet_transaction_ref STRING,
  ceiling_updated STRING,
  rejection_reason STRING,
  annual_rate STRING,
  annual_tci STRING,
  m2t_remuneration STRING,
  net_annual_rate STRING,
  effective_annual_rate_of_charge STRING,
  funds_unlock_retry_count STRING,
  nb_ops_paie_m1 STRING,
  nb_ops_paie_m2 STRING,
  nb_ops_paie_m3 STRING,
  nb_ops_paie_m4 STRING,
  nb_ops_paie_m5 STRING,
  nb_ops_paie_m6 STRING,
  nb_vir_recu_in_m1 STRING,
  nb_vir_recu_in_m2 STRING,
  nb_vir_recu_in_m3 STRING,
  nb_vir_recu_in_m4 STRING,
  nb_vir_recu_in_m5 STRING,
  nb_vir_recu_in_m6 STRING,
  mt_moy_hebdo_3m STRING,
  contract_nature STRING,
  moy_mens_pay_telec_1an STRING,
  moy_mens_pay_eauelec_1an STRING,
  moy_mens_trans_emis_1an STRING,
  moy_mens_trans_recus_1an STRING,
  nb_fact_oay_horsrecouv_1an STRING,
  nb_fact_oay_1an STRING,
  awarded_deadlines STRING,
  rejection_flag STRING,
  produit STRING,
  account_active STRING,
  cdg_creation_date STRING,
  cdg_nb_bourses STRING,
  cdg_total_amount STRING,
  cdgmad_creation_date STRING,
  cdgmad_gtrx_etat STRING,
  cdgmad_gtrx_mnt STRING,
  cdgmad_gtrx_num STRING,
  last_amount STRING,
  last_amount_date STRING,
  code_es STRING
)
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
STORED AS TEXTFILE;


CREATE EXTERNAL TABLE clients(
  id STRING,
  deleted STRING,
  version STRING,
  created_date STRING,
  address varchar(250),
  birthday STRING,
  channel_code STRING,
  code_ls STRING,
  email STRING,
  first_name STRING,
  id_number STRING,
  id_expiration_date STRING,
  last_name STRING,
  partner_code STRING,
  phone_number STRING,
  rib STRING,
  sequence STRING,
  wallet_creation_date STRING,
  wallet_id STRING,
  fk_id_type STRING,
  fk_nationality STRING,
  country_code STRING,
  entry_relation_date STRING,
  gender STRING,
  wallet_level STRING,
  internal_account_rib STRING,
  age STRING,
  m2t_client_id STRING,
  city_code STRING,
  city_label STRING
)
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
STORED AS TEXTFILE;

///create output table
CREATE EXTERNAL TABLE OUTPUT_TABLE_ETL_Backup(
  client_id varchar(100),
  loan_request_id varchar(100),
  n_gsm varchar(15),
  nom varchar(20),
  prenom varchar(20),
  age int,
  city varchar(30),
  gender int,
  code_dossier varchar(100),
  montant_demande float,
  montant_accorde float,
  date_demande_credit varchar(100),
  heure_demande_credit varchar(15),
  statut_dossier varchar(15),
  nombre_echeance varchar(15),
  date_echeance1 varchar(15),
  date_echeance2 varchar(15),
  date_echeance3 varchar(15),
  date_echeance4 varchar(15),
  free_de_service int,
  taux_d_interet float,
  code_agence varchar(10),
  code_es varchar(10),
  produit varchar(20),
  method varchar(30),
  deadline varchar(40),
  payment_date varchar(50),
  status varchar(50),
  MOTIF_DE_REJET varchar(50),
  DATE_REMBOURSEMENT_DERNIERE_ECHEANCE varchar(20),
  DATE_REGLEMENT_IMPAYE_DERNIERE_ECHEANCE varchar(20),
  DATE_PRELEVEMENT_DERNIERE_ECHEANCE varchar(20)
)
ROW FORMAT DELIMITED FIELDS TERMINATED BY ';'
STORED AS TEXTFILE;



CREATE VIEW TempA AS
SELECT
    cl.id AS id1,
    lr.id AS id2,
    cl.phone_number AS N_GSM,
    cl.first_name AS NOM,
    cl.last_name AS PRENOM,
    lr.code_ls AS CODE_DOSSIER,
    lr.requested_amount AS MONTANT_DEMANDE,
    lr.awarded_amount AS MONTANT_ACCORDE,
    FROM_UNIXTIME(UNIX_TIMESTAMP(lr.created_date, 'yyyy-MM-dd HH:mm:ss'), 'yyyy-MM-dd') AS DATE_DEMANDE_CREDIT,
    FROM_UNIXTIME(UNIX_TIMESTAMP(lr.created_date, 'yyyy-MM-dd HH:mm:ss'), 'HH:mm:ss') AS HEURE_DEMANDE_CREDIT,
    lr.status AS STATUT_DOSSIER,
    CASE
        WHEN lr.rejection_reason IS NULL THEN 'No Reason'
        ELSE lr.rejection_reason
    END AS MOTIF_DE_REJET,
    COALESCE(lr.requested_deadlines, '0') AS NOMBRE_ECHEANCE,
    MAX(CASE WHEN pd.deadline_order = 1 THEN pd.deadline END) AS DATE_ECHEANCE1,
    MAX(CASE WHEN pd.deadline_order = 2 THEN pd.deadline END) AS DATE_ECHEANCE2,
    MAX(CASE WHEN pd.deadline_order = 3 THEN pd.deadline END) AS DATE_ECHEANCE3,
    MAX(CASE WHEN pd.deadline_order = 4 THEN pd.deadline END) AS DATE_ECHEANCE4,
    lr.fees AS FREE_DE_SERVICE,
    lr.rate AS TAUX_D_INTERET,
    CASE
        WHEN lr.code_es = '123456' THEN '012006'
        ELSE lr.code_es
    END AS CODE_AGENCE
FROM clients cl
    LEFT JOIN loan_request lr ON cl.id = lr.fk_client
    LEFT JOIN (
        SELECT pd.fk_loan_request, pd.deadline,
               ROW_NUMBER() OVER (PARTITION BY pd.fk_loan_request ORDER BY pd.deadline) AS deadline_order
        FROM payment_deadline pd
    ) pd ON lr.id = pd.fk_loan_request
WHERE lr.produit = 'TAYSSIR' AND lr.created_date >= '2024-06-13'
GROUP BY cl.id, lr.id, cl.phone_number, cl.first_name, cl.last_name, lr.code_ls, lr.requested_amount, lr.awarded_amount, lr.created_date, lr.status, lr.rejection_reason, lr.requested_deadlines, lr.fees, lr.rate, lr.code_es
ORDER BY DATE_DEMANDE_CREDIT DESC;


